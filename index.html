<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å¼è‹±èªæ‹¼å­—æŒ‘æˆ°è³½ - é€²éšé™¤éŒ¯ç‰ˆ</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --success: #00b894;
            --danger: #ff7675;
            --dark: #2d3436;
            --light: #f9f9f9;
        }

        body {
            font-family: 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }

        #app {
            background: white; width: 90%; max-width: 500px; padding: 30px; border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center;
        }

        .header-info { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; }
        .timer { color: var(--danger); }
        .score { color: var(--success); }

        .quiz-container {
            background: var(--light); padding: 30px; border-radius: 16px; margin-bottom: 20px;
            border: 2px solid #eee; position: relative;
        }

        #mode-indicator { position: absolute; top: 10px; right: 10px; font-size: 0.8rem; color: #999; }
        #chinese-word { font-size: 2.8rem; margin: 0; color: var(--dark); }

        #word-input {
            width: 100%; padding: 15px; font-size: 1.8rem; border: 3px solid #dfe6e9;
            border-radius: 12px; text-align: center; outline: none; box-sizing: border-box;
        }

        #word-input.error { border-color: var(--danger); animation: shake 0.3s; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .btn {
            cursor: pointer; border: none; padding: 12px 28px; border-radius: 12px;
            font-size: 1.1rem; font-weight: bold; transition: 0.3s; margin: 10px 5px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-audio { background: #fdcb6e; color: #634d00; margin-top: 15px; }

        .leaderboard-table { width: 100%; margin-top: 15px; border-collapse: collapse; }
        .leaderboard-table th, .leaderboard-table td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="app">
    <div id="start-screen">
        <h1 style="color: var(--primary);">ğŸ§ é€²éšæ‹¼å­—æŒ‘æˆ°</h1>
        <p>1. ç­”å° +10åˆ† / ç­”éŒ¯ -5åˆ†<br>2. éŒ¯é¡Œæœƒåœ¨æœ€å¾Œé‡æ–°å‡ºç¾<br>3. é™æ™‚ 3 åˆ†é˜</p>
        <button class="btn btn-primary" onclick="initGame()">é–‹å§‹æŒ‘æˆ°</button>
    </div>

    <div id="game-screen" class="hidden">
        <div class="header-info">
            <span class="timer" id="timer">â± 03:00</span>
            <span class="score" id="score">å¾—åˆ†: 0</span>
        </div>
        
        <div class="quiz-container">
            <div id="mode-indicator">ç¬¬ä¸€è¼ªé¡Œç›®</div>
            <h2 id="chinese-word">---</h2>
            <button class="btn btn-audio" onclick="speakWord()">ğŸ”Š è½ç™¼éŸ³</button>
        </div>
        
        <input type="text" id="word-input" placeholder="è«‹è¼¸å…¥è‹±æ–‡..." autocomplete="off">
    </div>

    <div id="result-screen" class="hidden">
        <h2>æŒ‘æˆ°çµæŸï¼</h2>
        <p style="font-size: 1.5rem;">æœ€çµ‚å¾—åˆ†ï¼š<span id="final-score-val" style="color:var(--primary);">0</span></p>
        
        <div id="save-area">
            <input type="text" id="player-name" placeholder="è¼¸å…¥åå­—" style="padding:10px; border-radius:8px; border:1px solid #ddd;">
            <button class="btn btn-primary" onclick="saveScore()">å„²å­˜</button>
        </div>

        <div id="leaderboard-area">
            <h3>ğŸ† æ’è¡Œæ¦œ</h3>
            <table class="leaderboard-table">
                <thead><tr><th>åæ¬¡</th><th>åå­—</th><th>å¾—åˆ†</th></tr></thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
        <button class="btn btn-primary" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<script>
    const originalWords = [
        {en: "like", zh: "å–œæ­¡"}, {en: "sport", zh: "é‹å‹•"}, {en: "much", zh: "éå¸¸/å¾ˆå¤š"},
        {en: "team", zh: "åœ˜éšŠ"}, {en: "practice", zh: "ç·´ç¿’"}, {en: "every", zh: "æ¯ä¸€å€‹"},
        {en: "then", zh: "ç„¶å¾Œ"}, {en: "swim", zh: "æ¸¸æ³³"}, {en: "join", zh: "åŠ å…¥"},
        {en: "eye", zh: "çœ¼ç›"}, {en: "hair", zh: "é ­é«®"}, {en: "know", zh: "çŸ¥é“"},
        {en: "hundred", zh: "ç™¾"}, {en: "centimeter", zh: "å…¬åˆ†"}, {en: "guitar", zh: "å‰ä»–"},
        {en: "piano", zh: "é‹¼ç´"}, {en: "nose", zh: "é¼»å­"}, {en: "leg", zh: "è…¿"},
        {en: "large", zh: "å¤§çš„"}, {en: "ear", zh: "è€³æœµ"}, {en: "mouth", zh: "å˜´å·´"},
        {en: "thick", zh: "åšçš„"}, {en: "lip", zh: "å˜´å”‡"}, {en: "strong", zh: "å¼·å£¯çš„"},
        {en: "arm", zh: "æ‰‹è‡‚"}, {en: "height", zh: "é«˜åº¦"}, {en: "player", zh: "é¸æ‰‹"},
        {en: "the USA", zh: "ç¾åœ‹"}, {en: "body", zh: "èº«é«”"}, {en: "stand out", zh: "è„«ç©è€Œå‡º"},
        {en: "different", zh: "ä¸åŒçš„"}, {en: "top", zh: "é ‚å°–çš„"}
    ];

    let score = 0;
    let timeLeft = 180;
    let timerInterval;
    let currentWordObj;
    let activeQueue = []; // ç›®å‰è¦è€ƒçš„é¡Œåº«
    let wrongQueue = [];  // ç­”éŒ¯çš„é¡Œåº«
    let isReviewMode = false;

    const inputEl = document.getElementById('word-input');

    function initGame() {
        score = 0;
        timeLeft = 180;
        isReviewMode = false;
        activeQueue = [...originalWords].sort(() => Math.random() - 0.5);
        wrongQueue = [];
        
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        updateScoreDisplay();
        nextQuestion();
        startTimer();
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `â± ${m}:${s}`;
            if (timeLeft <= 0) endGame();
        }, 1000);
    }

    function nextQuestion() {
        if (activeQueue.length === 0) {
            if (wrongQueue.length > 0) {
                // é€²å…¥éŒ¯é¡Œé‡æ¸¬æ¨¡å¼
                isReviewMode = true;
                activeQueue = [...wrongQueue];
                wrongQueue = [];
                document.getElementById('mode-indicator').innerText = "éŒ¯é¡Œè¤‡ç¿’æ¨¡å¼";
                document.getElementById('mode-indicator').style.color = "var(--danger)";
            } else {
                // æ‰€æœ‰é¡Œç›®éƒ½ç­”å°äº†ï¼Œææ—©çµæŸæˆ–é‡æ–°é–‹å§‹ä¸€è¼ª
                endGame();
                return;
            }
        }

        currentWordObj = activeQueue.shift();
        document.getElementById('chinese-word').innerText = currentWordObj.zh;
        inputEl.value = "";
        inputEl.focus();
        setTimeout(speakWord, 300);
    }

    inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            checkAnswer();
        }
    });

    function checkAnswer() {
        const userValue = inputEl.value.trim().toLowerCase();
        const correctValue = currentWordObj.en.toLowerCase();

        if (userValue === correctValue) {
            score += 10;
            updateScoreDisplay();
            nextQuestion();
        } else {
            // ç­”éŒ¯é‚è¼¯
            score = Math.max(0, score - 5);
            wrongQueue.push(currentWordObj); // åŠ å…¥éŒ¯é¡Œæœ¬
            updateScoreDisplay();
            
            // éŒ¯èª¤è¦–è¦ºå›é¥‹
            inputEl.classList.add('error');
            setTimeout(() => inputEl.classList.remove('error'), 300);
            
            nextQuestion(); // ç›´æ¥è·³è½‰ä¸‹ä¸€é¡Œ
        }
    }

    function updateScoreDisplay() {
        document.getElementById('score').innerText = `å¾—åˆ†: ${score}`;
    }

    function speakWord() {
        if (!currentWordObj) return;
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(currentWordObj.en);
        utter.lang = 'en-US';
        window.speechSynthesis.speak(utter);
    }

    function endGame() {
        clearInterval(timerInterval);
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('final-score-val').innerText = score;
        updateLeaderboardDisplay();
    }

    function saveScore() {
        const name = document.getElementById('player-name').value.trim() || "åŒ¿åçƒå“¡";
        const leaderboard = JSON.parse(localStorage.getItem('spell_expert_rank') || "[]");
        leaderboard.push({ name, score, date: new Date().toLocaleDateString() });
        leaderboard.sort((a, b) => b.score - a.score);
        localStorage.setItem('spell_expert_rank', JSON.stringify(leaderboard.slice(0, 5)));
        document.getElementById('save-area').innerHTML = "<p>æˆç¸¾å·²å„²å­˜ï¼</p>";
        updateLeaderboardDisplay();
    }

    function updateLeaderboardDisplay() {
        const leaderboard = JSON.parse(localStorage.getItem('spell_expert_rank') || "[]");
        const tbody = document.getElementById('leaderboard-body');
        tbody.innerHTML = leaderboard.map((r, i) => `<tr><td>${i+1}</td><td>${r.name}</td><td>${r.score}</td></tr>`).join('');
    }
</script>

</body>
</html>