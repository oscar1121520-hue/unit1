<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å¼è‹±èªé›™æ¨¡æŒ‘æˆ° - æœ€çµ‚å®Œæ•´ç‰ˆ</title>
    <style>
        :root { --primary: #6c5ce7; --success: #00b894; --danger: #ff7675; --dark: #2d3436; --light: #f9f9f9; --accent: #fdcb6e; }
        body { font-family: 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #app { background: white; width: 95%; max-width: 600px; padding: 25px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center; margin: 20px 0; }
        
        /* æ¨¡å¼é¸æ“‡éˆ• */
        .mode-container { display: flex; gap: 15px; justify-content: center; margin: 20px 0; }
        .btn-mode { flex: 1; padding: 20px; border-radius: 16px; border: 2px solid #eee; cursor: pointer; transition: 0.3s; background: white; }
        .btn-mode:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-mode h3 { margin: 0 0 10px 0; color: var(--primary); }

        /* éŠæˆ²ä»‹é¢ */
        .header-info { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; }
        .quiz-container { background: var(--light); padding: 25px; border-radius: 16px; margin-bottom: 20px; border: 2px solid #eee; }
        #display-word { font-size: 2.8rem; margin: 0; color: var(--dark); word-break: break-all; }
        
        /* æ¨¡å¼äºŒé¸é … */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .option-btn { padding: 12px; background: white; border: 2px solid #dfe6e9; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .option-btn:hover { border-color: var(--primary); background: #f8f8ff; }
        .option-btn.wrong { background: var(--danger); color: white; border-color: var(--danger); }

        /* æ’è¡Œæ¦œåˆ†é  */
        .rank-tabs { display: flex; gap: 5px; margin-top: 20px; }
        .rank-tab { flex: 1; padding: 10px; font-size: 0.85rem; background: #eee; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; }
        .rank-tab.active { background: var(--primary); color: white; }
        .scroll-area { max-height: 220px; overflow-y: auto; background: #fafafa; border: 1px solid #eee; border-radius: 0 0 10px 10px; padding: 10px; }
        .rank-table, .wrong-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .rank-table td, .wrong-table td { padding: 8px; border-bottom: 1px solid #eee; }
        
        /* éŒ¯é¡Œå°ç…§ */
        .wrong-box { background: #fff5f5; border: 2px solid #ff7675; border-radius: 16px; padding: 15px; margin-bottom: 20px; }
        .txt-wrong { color: var(--danger); text-decoration: line-through; font-size: 0.8rem; display: block; }
        .txt-correct { color: var(--success); font-weight: bold; font-size: 1rem; }

        .hidden { display: none; }
        .btn { cursor: pointer; border: none; padding: 12px 28px; border-radius: 12px; font-weight: bold; transition: 0.3s; }
        .penalty-flash { color: var(--danger); animation: flash 0.5s; font-size: 1.2rem; }
        @keyframes flash { 50% { opacity: 0; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake { animation: shake 0.3s; }
    </style>
</head>
<body>

<div id="app">
    <div id="start-screen">
        <h1 style="color: var(--primary);">ğŸ§ è‹±èªé›™æ¨¡æŒ‘æˆ°</h1>
        <div id="status-msg">ğŸ“¡ æ­£åœ¨è¼‰å…¥é›²ç«¯é¡Œåº«...</div>
        
        <div id="mode-select" class="hidden">
            <div class="mode-container">
                <div class="btn-mode" onclick="setupGame(1)">
                    <h3>æ¨¡å¼ A</h3><p>æ‹¼å­—æŒ‘æˆ°<br>(500ç§’æ¯”ç©åˆ†)</p>
                </div>
                <div class="btn-mode" onclick="setupGame(2)">
                    <h3>æ¨¡å¼ B</h3><p>è¾¨èªæŒ‘æˆ°<br>(å…¨é¡Œæ•¸æ¯”é€Ÿåº¦)</p>
                </div>
            </div>

            <div class="rank-tabs">
                <div id="tabA" class="rank-tab active" onclick="switchTab('A')">æ‹¼å­—æ’è¡Œæ¦œ</div>
                <div id="tabB" class="rank-tab" onclick="switchTab('B')">è¾¨èªé€Ÿåº¦æ¦œ</div>
            </div>
            <div class="scroll-area">
                <table id="rank-body" class="rank-table"></table>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div class="header-info">
            <span id="timer-display">â± è¼‰å…¥ä¸­...</span>
            <span id="score-info">å¾—åˆ†: 0</span>
        </div>
        <div class="quiz-container">
            <h2 id="display-word">---</h2>
            <div id="word-type" style="color:var(--primary); font-weight:bold; height:1.2rem; margin-top:5px;"></div>
            <button class="btn" style="background:var(--accent); margin-top:15px;" onclick="speakWord()">ğŸ”Š è½ç™¼éŸ³</button>
        </div>

        <div id="mode1-input" class="hidden">
            <div style="display:flex; gap:10px;">
                <input type="text" id="word-input" placeholder="è«‹æ‹¼å­—..." style="flex:1; padding:15px; font-size:1.5rem; border:2px solid #ddd; border-radius:12px; text-align:center;" autocapitalize="off" spellcheck="false" autocomplete="off">
                <button class="btn" style="background:var(--success); color:white;" onclick="checkAnswerMode1()">OK</button>
            </div>
        </div>

        <div id="mode2-options" class="hidden">
            <div class="options-grid" id="options-container"></div>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <h2 id="result-title">æŒ‘æˆ°çµæŸ</h2>
        
        <div id="wrong-summary-area" class="wrong-box hidden">
            <h3 style="margin:0 0 10px; color:var(--danger); font-size:1rem;">ğŸ” éŒ¯é¡Œå°ç…§ (è«‹è¨˜ä½æ­£ç¢ºæ‹¼æ³•)</h3>
            <div class="scroll-area" style="background:white;">
                <table class="wrong-table">
                    <thead><tr style="background:#f8f8f8;"><th>é¡Œç›®</th><th>ä½ çš„ç­”æ¡ˆ</th><th>æ­£ç¢ºç­”æ¡ˆ</th></tr></thead>
                    <tbody id="wrong-summary-body"></tbody>
                </table>
            </div>
        </div>

        <div id="result-stats" style="background: var(--light); padding:15px; border-radius:12px; text-align:left; margin-bottom:20px; border:1px solid #ddd;"></div>
        
        <div id="save-area">
            <input type="text" id="player-name" placeholder="è¼¸å…¥åå­—ç™»éŒ„æˆç¸¾" style="padding:10px; border-radius:8px; border:1px solid #ddd; width: 60%; margin-bottom:10px;">
            <button class="btn" style="background:var(--primary); color:white; width:100%;" onclick="saveScore()">ä¸Šå‚³æˆç¸¾</button>
        </div>
        <button class="btn" style="background:var(--success); color:white; width:100%; margin-top:15px;" onclick="location.reload()">å›é¦–é </button>
    </div>
</div>

<script>
    // å›ºå®šçš„ API ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbz9EaCviDbRaeWOSbOxPTZV69VAwqc8pr5YcboACUDoFWK1Dn1NCza5vnwRDBn21Sk/exec";
    
    let wordBank = [], activeQueue = [], currentWordObj;
    let gameMode = 1, timer = 0, score = 0, correctCount = 0, totalAnswered = 0, penalties = 0, timerInterval;
    let wrongList = [], rankDataCache = { rankA: [], rankB: [] };

    window.onload = async () => {
        try {
            const [wordRes, rankRes] = await Promise.all([
                fetch(`${API_URL}?action=getWords`),
                fetch(API_URL)
            ]);
            wordBank = await wordRes.json();
            rankDataCache = await rankRes.json();
            
            if (wordBank && wordBank.length > 0) {
                document.getElementById('status-msg').classList.add('hidden');
                document.getElementById('mode-select').classList.remove('hidden');
                switchTab('A');
            } else {
                document.getElementById('status-msg').innerText = "âš  é¡Œåº«ç›®å‰æ˜¯ç©ºçš„ã€‚";
            }
        } catch (e) {
            document.getElementById('status-msg').innerText = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API éƒ¨ç½²ã€‚";
            console.error(e);
        }
    };

    function switchTab(type) {
        document.getElementById('tabA').classList.toggle('active', type === 'A');
        document.getElementById('tabB').classList.toggle('active', type === 'B');
        const data = (type === 'A') ? rankDataCache.rankA : rankDataCache.rankB;
        const unit = (type === 'A') ? "åˆ†" : "ç§’";
        
        document.getElementById('rank-body').innerHTML = (data && data.length > 0) ? 
            data.map((r, i) => `<tr><td>${i+1}. ${r[0]}</td><td align="right"><b>${r[1]}</b> ${unit} (${r[3] || '0%'})</td></tr>`).join('') :
            '<tr><td colspan="2">æš«ç„¡æ•¸æ“š</td></tr>';
    }

    function setupGame(mode) {
        gameMode = mode;
        score = 0; correctCount = 0; totalAnswered = 0; penalties = 0; wrongList = [];
        activeQueue = [...wordBank].sort(() => Math.random() - 0.5);
        
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        if (mode === 1) {
            timer = 500;
            document.getElementById('mode1-input').classList.remove('hidden');
            document.getElementById('mode2-options').classList.add('hidden');
            document.getElementById('score-info').innerText = "å¾—åˆ†: 0";
        } else {
            timer = 0;
            document.getElementById('mode2-options').classList.remove('hidden');
            document.getElementById('mode1-input').classList.add('hidden');
            document.getElementById('score-info').innerText = `é€²åº¦: 0 / ${wordBank.length}`;
        }
        
        nextQuestion();
        startTimer();
    }

    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (gameMode === 1) {
                if (timer > 0) timer--;
                else endGame();
                document.getElementById('timer-display').innerText = `â± å€’æ•¸: ${timer}s`;
            } else {
                timer++;
                document.getElementById('timer-display').innerText = `â± è€—æ™‚: ${timer}s`;
            }
        }, 1000);
    }

    function nextQuestion() {
        if (activeQueue.length === 0) { endGame(); return; }
        currentWordObj = activeQueue.shift();
        
        const displayWordEl = document.getElementById('display-word');
        const wordTypeEl = document.getElementById('word-type');
        const inputEl = document.getElementById('word-input');

        if (gameMode === 1) {
            displayWordEl.innerText = currentWordObj.zh;
            wordTypeEl.innerText = currentWordObj.type ? `[${currentWordObj.type}]` : "";
            inputEl.value = ""; 
            inputEl.focus();
        } else {
            displayWordEl.innerText = currentWordObj.en;
            wordTypeEl.innerText = "";
            generateOptions();
        }
        speakWord();
    }

    function checkAnswerMode1() {
        const input = document.getElementById('word-input');
        const rawVal = input.value.trim();
        if (!rawVal) return;

        totalAnswered++;
        // ä¸åˆ†å¤§å°å¯«åˆ¤å®š
        if (rawVal.toLowerCase() === currentWordObj.en.toLowerCase()) {
            score += 10; correctCount++;
        } else {
            score = Math.max(0, score - 5);
            wrongList.push({ zh: currentWordObj.zh, en: currentWordObj.en, user: rawVal });
            input.classList.add('shake');
            setTimeout(() => input.classList.remove('shake'), 300);
        }
        document.getElementById('score-info').innerText = "å¾—åˆ†: " + score;
        nextQuestion();
    }

    function generateOptions() {
        const container = document.getElementById('options-container');
        container.innerHTML = "";
        
        let dists = wordBank
            .filter(w => w.zh !== currentWordObj.zh)
            .sort(() => Math.random() - 0.5)
            .slice(0, 9)
            .map(w => w.zh);
        
        let choices = [...dists, currentWordObj.zh].sort(() => Math.random() - 0.5);
        
        choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = "option-btn"; btn.innerText = c;
            btn.onclick = () => {
                if (c === currentWordObj.zh) { 
                    correctCount++; 
                    document.getElementById('score-info').innerText = `é€²åº¦: ${correctCount} / ${wordBank.length}`;
                    nextQuestion(); 
                } else { 
                    penalties++; timer += 3;
                    document.getElementById('timer-display').classList.add('penalty-flash');
                    setTimeout(() => document.getElementById('timer-display').classList.remove('penalty-flash'), 500);
                    btn.classList.add('wrong'); btn.disabled = true;
                }
            };
            container.appendChild(btn);
        });
    }

    function speakWord() { 
        window.speechSynthesis.cancel(); 
        const u = new SpeechSynthesisUtterance(currentWordObj.en); 
        u.lang = 'en-US'; u.rate = 0.9;
        window.speechSynthesis.speak(u); 
    }

    function endGame() {
        clearInterval(timerInterval);
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        
        const summaryArea = document.getElementById('wrong-summary-area');
        if (wrongList.length > 0) {
            summaryArea.classList.remove('hidden');
            document.getElementById('wrong-summary-body').innerHTML = wrongList.map(item => `
                <tr><td>${item.zh}</td><td><span class="txt-wrong">${item.user}</span></td><td><span class="txt-correct">${item.en}</span></td></tr>
            `).join('');
        } else {
            summaryArea.classList.add('hidden');
        }

        let finalValue = (gameMode === 1) ? (score + timer) : timer;
        document.getElementById('result-stats').innerHTML = (gameMode === 1) ? 
            `æ¨¡å¼ï¼šæ‹¼å­—æŒ‘æˆ°<br>ç­”é¡Œå¾—åˆ†ï¼š${score}<br>æ™‚é–“çå‹µï¼š${timer}<br><b>æœ€çµ‚ç¸½ç©åˆ†ï¼š${finalValue}</b>` : 
            `æ¨¡å¼ï¼šè¾¨èªæŒ‘æˆ°<br>ç­”é¡Œæ•¸é‡ï¼š${correctCount}<br>éŒ¯èª¤æ¬¡æ•¸ï¼š${penalties}<br><b>æœ€çµ‚ç¸½è€—æ™‚ï¼š${finalValue} ç§’</b>`;
        
        // æš«å­˜æœ€çµ‚åˆ†æ•¸ç”¨æ–¼ä¸Šå‚³
        score = finalValue;
    }

    async function saveScore() {
        const name = document.getElementById('player-name').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥åå­—");
        
        const saveArea = document.getElementById('save-area');
        saveArea.innerHTML = "â³ æ­£åœ¨åŒæ­¥è‡³é›²ç«¯...";
        
        const totalAttempts = (gameMode === 1) ? totalAnswered : (correctCount + penalties);
        const acc = Math.round((correctCount / (totalAttempts || 1)) * 100) + "%";
        
        try {
            await fetch(API_URL, { 
                method: "POST", 
                mode: "no-cors", 
                body: JSON.stringify({ 
                    name: name, 
                    score: score, 
                    accuracy: acc, 
                    mode: (gameMode === 1 ? "æ‹¼å­—" : "è¾¨èª") 
                }) 
            });
            saveArea.innerHTML = "<p style='color:var(--success); font-weight:bold;'>âœ… æˆç¸¾ç™»éŒ„æˆåŠŸï¼</p>";
        } catch (e) {
            saveArea.innerHTML = "<p style='color:var(--danger);'>âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>";
        }
    }

    // æ”¯æ´ Enter éµé€å‡º
    document.getElementById('word-input').addEventListener('keydown', (e) => { 
        if(e.key === 'Enter') checkAnswerMode1(); 
    });
</script>
</body>
</html>
