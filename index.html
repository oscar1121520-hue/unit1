<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å¼è‹±èªæ‹¼å­—æŒ‘æˆ° - è³½å‰æ’è¡Œç‰ˆ</title>
    <style>
        :root {
            --primary: #6c5ce7; --success: #00b894; --danger: #ff7675;
            --dark: #2d3436; --light: #f9f9f9; --accent: #fdcb6e;
        }
        body {
            font-family: 'Segoe UI', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        #app {
            background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center; margin: 20px 0;
        }
        .header-info { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; }
        .quiz-container {
            background: var(--light); padding: 30px; border-radius: 16px; margin-bottom: 20px;
            border: 2px solid #eee; position: relative;
        }
        #chinese-word { font-size: 2.8rem; margin: 0; color: var(--dark); }
        #word-input {
            width: 100%; padding: 15px; font-size: 1.8rem; border: 3px solid #dfe6e9;
            border-radius: 12px; text-align: center; outline: none; box-sizing: border-box;
        }
        #word-input.error { border-color: var(--danger); animation: shake 0.3s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .btn {
            cursor: pointer; border: none; padding: 12px 28px; border-radius: 12px;
            font-size: 1.1rem; font-weight: bold; transition: 0.3s; margin: 5px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-audio { background: var(--accent); color: #634d00; margin-top: 15px; }
        .scroll-area { max-height: 160px; overflow-y: auto; background: #fafafa; border-radius: 10px; padding: 10px; border: 1px solid #eee; margin-top: 10px; }
        .leaderboard-table, .wrong-list-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .leaderboard-table td, .wrong-list-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        .hidden { display: none; }
        #status-msg { font-size: 0.9rem; color: #666; margin-bottom: 10px; padding: 15px; background: #f0f0f0; border-radius: 12px; }
        .score-detail { background: var(--light); padding: 15px; border-radius: 12px; margin-bottom: 15px; font-size: 0.9rem; }
        .rank-title { margin: 20px 0 5px 0; color: var(--primary); font-size: 1.1rem; }
    </style>
</head>
<body>

<div id="app">
    <div id="start-screen">
        <h1 style="color: var(--primary); margin-bottom: 5px;">ğŸ§ é›²ç«¯æ‹¼å­—æŒ‘æˆ°</h1>
        <div id="status-msg">ğŸ“¡ æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>
        
        <button id="start-btn" class="btn btn-primary hidden" onclick="initGame()">é–‹å§‹æŒ‘æˆ°</button>
        
        <div id="pre-leaderboard" class="hidden">
            <h3 class="rank-title">ğŸ† å…¨çƒé«˜æ‰‹æ¦œ (Top 10)</h3>
            <div class="scroll-area">
                <table class="leaderboard-table">
                    <tbody id="start-leaderboard-body"></tbody>
                </table>
            </div>
        </div>
        <p style="font-size: 0.75rem; color: #888; margin-top: 15px;">ç­”å°+10ï¼Œç­”éŒ¯-5ã€‚å‰©é¤˜æ™‚é–“å°‡è½‰ç‚ºçå‹µåˆ†ï¼</p>
    </div>

    <div id="game-screen" class="hidden">
        <div class="header-info">
            <span id="timer" style="color:var(--danger)">â± 03:00</span>
            <span id="score" style="color:var(--success)">å¾—åˆ†: 0</span>
        </div>
        <div class="quiz-container">
            <h2 id="chinese-word">---</h2>
            <button class="btn btn-audio" onclick="speakWord()">ğŸ”Š è½ç™¼éŸ³</button>
        </div>
        <input type="text" id="word-input" placeholder="è¼¸å…¥å–®å­—æŒ‰ Enter" autocomplete="off">
    </div>

    <div id="result-screen" class="hidden">
        <h2 style="margin-bottom:10px">æŒ‘æˆ°çµæœ</h2>
        
        <div class="score-detail">
            <div style="display:flex; justify-content: space-between; margin-bottom:5px;">
                <span>ç­”é¡Œç©åˆ†ï¼š</span><span id="base-score">0</span>
            </div>
            <div style="display:flex; justify-content: space-between; margin-bottom:5px; color:var(--primary)">
                <span>æ™‚é–“çå‹µ (ç§’æ•¸Ã—2)ï¼š</span><span id="time-bonus">0</span>
            </div>
            <hr style="border: 0; border-top: 1px solid #ddd;">
            <div style="display:flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem;">
                <span>ç¸½åˆ†ï¼š</span><span id="final-score-val" style="color:var(--success)">0</span>
            </div>
        </div>
        
        <div id="save-area">
            <input type="text" id="player-name" placeholder="è¼¸å…¥åå­—" style="padding:10px; border-radius:8px; border:1px solid #ddd; width: 45%;">
            <button class="btn btn-primary" style="padding: 10px 15px; font-size: 0.9rem;" onclick="saveScore()">ä¸Šå‚³æˆç¸¾</button>
        </div>

        <div id="wrong-words-section" class="hidden">
            <h3 style="margin: 20px 0 5px 0; color: var(--danger);">ğŸ” éŒ¯é¡Œç­†è¨˜ (æ­£ç¢ºç­”æ¡ˆ)</h3>
            <div class="scroll-area">
                <table class="wrong-list-table"><tbody id="wrong-list-body"></tbody></table>
            </div>
        </div>

        <div id="leaderboard-area">
            <h3 class="rank-title">ğŸ† æœ€æ–°æ’è¡Œæ¦œ</h3>
            <div class="scroll-area">
                <table class="leaderboard-table"><tbody id="end-leaderboard-body"></tbody></table>
            </div>
        </div>
        <button class="btn btn-primary" style="background: var(--success); width: 100%; margin-top: 20px;" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz9EaCviDbRaeWOSbOxPTZV69VAwqc8pr5YcboACUDoFWK1Dn1NCza5vnwRDBn21Sk/exec";

    let wordBank = [];
    let score = 0, timeLeft = 180, timerInterval, currentWordObj;
    let activeQueue = [], historyOfWrongs = new Map();
    const inputEl = document.getElementById('word-input');

    // å•Ÿå‹•æ™‚ï¼šè®€å–é¡Œåº« + è®€å–æ’è¡Œæ¦œ
    window.onload = async () => {
        const msg = document.getElementById('status-msg');
        try {
            // åŒæ™‚ç™¼å‡ºé¡Œåº«èˆ‡æ’è¡Œæ¦œçš„è«‹æ±‚
            const [wordRes, rankRes] = await Promise.all([
                fetch(`${API_URL}?action=getWords`),
                fetch(API_URL)
            ]);
            
            wordBank = await wordRes.json();
            const rankData = await rankRes.json();

            if (wordBank && wordBank.length > 0) {
                msg.innerText = `âœ… æº–å‚™å°±ç·’ï¼å…±æœ‰ ${wordBank.length} å€‹æŒ‘æˆ°å–®å­—`;
                document.getElementById('start-btn').classList.remove('hidden');
                
                // é¡¯ç¤ºè³½å‰æ’è¡Œæ¦œ
                if (rankData && rankData.length > 0) {
                    document.getElementById('pre-leaderboard').classList.remove('hidden');
                    renderLeaderboard('start-leaderboard-body', rankData);
                }
            }
        } catch (e) {
            msg.innerText = "âŒ ç„¡æ³•è®€å–é›²ç«¯è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API æ¬Šé™ã€‚";
        }
    };

    function renderLeaderboard(targetId, data) {
        const tbody = document.getElementById(targetId);
        tbody.innerHTML = data.map((r, i) => `
            <tr>
                <td style="width:20%; color:#888;">#${i+1}</td>
                <td style="width:50%; font-weight:bold; text-align:left;">${r[0]}</td>
                <td style="width:30%; color:var(--primary); font-weight:bold;">${r[1]}</td>
            </tr>
        `).join('');
    }

    function initGame() {
        score = 0; timeLeft = 180;
        activeQueue = [...wordBank].sort(() => Math.random() - 0.5);
        historyOfWrongs.clear();
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        updateScoreDisplay();
        nextQuestion();
        startTimer();
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            let s = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `â± ${m}:${s}`;
            if (timeLeft <= 0) endGame();
        }, 1000);
    }

    function nextQuestion() {
        if (activeQueue.length === 0) { endGame(); return; }
        currentWordObj = activeQueue.shift();
        document.getElementById('chinese-word').innerText = currentWordObj.zh;
        inputEl.value = "";
        inputEl.focus();
        setTimeout(speakWord, 300);
    }

    inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') checkAnswer();
    });

    function checkAnswer() {
        const userVal = inputEl.value.trim().toLowerCase();
        const correctVal = currentWordObj.en.trim().toLowerCase();
        
        if (userVal === correctVal) {
            score += 10;
        } else {
            score = Math.max(0, score - 5);
            historyOfWrongs.set(currentWordObj.zh, currentWordObj.en);
            inputEl.classList.add('error');
            setTimeout(() => inputEl.classList.remove('error'), 300);
        }
        updateScoreDisplay();
        nextQuestion();
    }

    function updateScoreDisplay() {
        document.getElementById('score').innerText = `å¾—åˆ†: ${score}`;
    }

    function speakWord() {
        if (!currentWordObj) return;
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(currentWordObj.en);
        utter.lang = 'en-US';
        utter.rate = 0.85;
        window.speechSynthesis.speak(utter);
    }

    function endGame() {
        clearInterval(timerInterval);
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');

        const timeBonus = Math.max(0, timeLeft * 2);
        const finalScore = score + timeBonus;

        document.getElementById('base-score').innerText = score;
        document.getElementById('time-bonus').innerText = `+ ${timeBonus}`;
        document.getElementById('final-score-val').innerText = finalScore;
        
        score = finalScore; // æº–å‚™ä¸Šå‚³çš„åˆ†æ•¸

        if (historyOfWrongs.size > 0) {
            document.getElementById('wrong-words-section').classList.remove('hidden');
            let wrongHtml = "";
            historyOfWrongs.forEach((en, zh) => {
                wrongHtml += `<tr><td>${zh}</td><td style="color:var(--success); font-weight:bold;">${en}</td></tr>`;
            });
            document.getElementById('wrong-list-body').innerHTML = wrongHtml;
        }
        updateFinalLeaderboard();
    }

    async function saveScore() {
        const name = document.getElementById('player-name').value.trim();
        if(!name) { alert("è«‹è¼¸å…¥åå­—ï¼"); return; }
        document.getElementById('save-area').innerHTML = "<p>â³ ä¸Šå‚³ç©åˆ†ä¸­...</p>";
        try {
            await fetch(API_URL, {
                method: "POST",
                mode: "no-cors", 
                body: JSON.stringify({ name: name, score: score })
            });
            setTimeout(() => {
                document.getElementById('save-area').innerHTML = "<p style='color:var(--success); font-weight:bold;'>âœ… æˆç¸¾å·²ç™»éŒ„ï¼</p>";
                updateFinalLeaderboard();
            }, 1200);
        } catch (e) {
            document.getElementById('save-area').innerHTML = "<p style='color:var(--danger)'>âŒ ä¸Šå‚³å¤±æ•—</p>";
        }
    }

    async function updateFinalLeaderboard() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            renderLeaderboard('end-leaderboard-body', data);
        } catch (e) {}
    }
</script>
</body>
</html>
