<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å¼è‹±èªæ‹¼å­—æŒ‘æˆ° - æ¨™æº–çå‹µç‰ˆ</title>
    <style>
        :root {
            --primary: #6c5ce7; --success: #00b894; --danger: #ff7675;
            --dark: #2d3436; --light: #f9f9f9; --accent: #fdcb6e;
        }
        body {
            font-family: 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        #app {
            background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center; margin: 20px 0;
        }
        .header-info { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; }
        .quiz-container {
            background: var(--light); padding: 30px; border-radius: 16px; margin-bottom: 20px;
            border: 2px solid #eee; position: relative;
        }
        #chinese-word { font-size: 2.8rem; margin: 0; color: var(--dark); }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        #word-input {
            flex: 1; padding: 15px; font-size: 1.5rem; border: 3px solid #dfe6e9;
            border-radius: 12px; text-align: center; outline: none; box-sizing: border-box;
        }
        #word-input.error { border-color: var(--danger); animation: shake 0.3s; }
        .btn-ok { 
            background: var(--success); color: white; padding: 0 25px; 
            font-size: 1.2rem; border-radius: 12px; cursor: pointer; 
            border: none; font-weight: bold;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .btn {
            cursor: pointer; border: none; padding: 12px 28px; border-radius: 12px;
            font-size: 1.1rem; font-weight: bold; transition: 0.3s; margin: 5px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-audio { background: var(--accent); color: #634d00; margin-top: 15px; }
        .scroll-area { max-height: 160px; overflow-y: auto; background: #fafafa; border-radius: 10px; padding: 10px; border: 1px solid #eee; margin-top: 10px; }
        .leaderboard-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .leaderboard-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        .hidden { display: none; }
        #status-msg { font-size: 0.9rem; color: #666; margin-bottom: 10px; padding: 15px; background: #f0f0f0; border-radius: 12px; }
        .score-detail { background: var(--light); padding: 15px; border-radius: 12px; margin-bottom: 15px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div id="app">
    <div id="start-screen">
        <h1 style="color: var(--primary);">ğŸ§ æ‹¼å­—æŒ‘æˆ° (500ç§’)</h1>
        <div id="status-msg">ğŸ“¡ æ­£åœ¨è¼‰å…¥é›²ç«¯é¡Œåº«...</div>
        <button id="start-btn" class="btn btn-primary hidden" onclick="initGame()">é–‹å§‹æŒ‘æˆ°</button>
        <div id="pre-leaderboard" class="hidden">
            <h3 style="color:var(--primary); font-size:1.1rem; margin-top:20px;">ğŸ† é«˜æ‰‹æ¦œ Top 10</h3>
            <div class="scroll-area"><table class="leaderboard-table"><tbody id="start-leaderboard-body"></tbody></table></div>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div class="header-info">
            <span id="timer" style="color:var(--danger)">â± 08:20</span>
            <span id="score" style="color:var(--success)">å¾—åˆ†: 0</span>
        </div>
        <div class="quiz-container">
            <h2 id="chinese-word">---</h2>
            <button class="btn btn-audio" onclick="speakWord()">ğŸ”Š è½ç™¼éŸ³</button>
        </div>
        <div class="input-group">
            <input type="text" id="word-input" placeholder="è«‹æ‹¼å­—..." autocomplete="off">
            <button class="btn-ok" onclick="checkAnswer()">OK</button>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <h2 style="margin-bottom:10px">æŒ‘æˆ°çµæŸ</h2>
        <div class="score-detail">
            <div style="display:flex; justify-content: space-between;"><span>ç­”é¡Œç´¯ç©å¾—åˆ† (+10/-5)ï¼š</span><span id="base-score">0</span></div>
            <div style="display:flex; justify-content: space-between; color:var(--primary)"><span>å‰©é¤˜æ™‚é–“åŠ åˆ† (1ç§’/1åˆ†)ï¼š</span><span id="time-bonus">0</span></div>
            <hr style="border:0; border-top:1px solid #ddd; margin:10px 0;">
            <div style="display:flex; justify-content: space-between; font-weight:bold; font-size:1.5rem;"><span>æœ€çµ‚ç¸½ç©åˆ†ï¼š</span><span id="final-score-val" style="color:var(--success)">0</span></div>
        </div>
        <div id="save-area">
            <input type="text" id="player-name" placeholder="è¼¸å…¥åå­—" style="padding:10px; border-radius:8px; border:1px solid #ddd; width: 45%;">
            <button class="btn btn-primary" onclick="saveScore()">ä¸Šå‚³æˆç¸¾</button>
        </div>
        <div id="wrong-words-section" class="hidden">
            <h3 style="margin:20px 0 5px 0; color:var(--danger);">ğŸ” éŒ¯é¡Œç­†è¨˜</h3>
            <div class="scroll-area"><table class="leaderboard-table"><tbody id="wrong-list-body"></tbody></table></div>
        </div>
        <h3 style="margin:20px 0 5px 0;">ğŸ† ç¸½æ’è¡Œæ¦œ</h3>
        <div class="scroll-area"><table class="leaderboard-table"><tbody id="end-leaderboard-body"></tbody></table></div>
        <button class="btn btn-primary" style="background:var(--success); width:100%; margin-top:20px;" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz9EaCviDbRaeWOSbOxPTZV69VAwqc8pr5YcboACUDoFWK1Dn1NCza5vnwRDBn21Sk/exec";

    let wordBank = [];
    let score = 0, timeLeft = 500, timerInterval, currentWordObj;
    let activeQueue = [], historyOfWrongs = new Map();
    const inputEl = document.getElementById('word-input');

    window.onload = async () => {
        const msg = document.getElementById('status-msg');
        try {
            const [wordRes, rankRes] = await Promise.all([
                fetch(`${API_URL}?action=getWords`),
                fetch(API_URL)
            ]);
            wordBank = await wordRes.json();
            const rankData = await rankRes.json();
            if (wordBank && wordBank.length > 0) {
                msg.innerText = "âœ… è³‡æ–™åŒæ­¥æˆåŠŸï¼";
                document.getElementById('start-btn').classList.remove('hidden');
                if (rankData) renderTable('start-leaderboard-body', rankData);
                document.getElementById('pre-leaderboard').classList.remove('hidden');
            }
        } catch (e) {
            msg.innerText = "âŒ é›²ç«¯é€£ç·šå¤±æ•—ã€‚";
        }
    };

    function renderTable(id, data) {
        document.getElementById(id).innerHTML = data.map((r, i) => `
            <tr><td style="width:20%; color:#888;">#${i+1}</td>
            <td style="width:50%; text-align:left; font-weight:bold;">${r[0]}</td>
            <td style="width:30%; color:var(--primary); font-weight:bold;">${r[1]}</td></tr>
        `).join('');
    }

    function initGame() {
        score = 0; timeLeft = 500;
        activeQueue = [...wordBank].sort(() => Math.random() - 0.5);
        historyOfWrongs.clear();
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        nextQuestion();
        startTimer();
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            let s = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `â± ${m}:${s}`;
            if (timeLeft <= 0) endGame();
        }, 1000);
    }

    function nextQuestion() {
        if (activeQueue.length === 0) { endGame(); return; }
        currentWordObj = activeQueue.shift();
        document.getElementById('chinese-word').innerText = currentWordObj.zh;
        inputEl.value = "";
        inputEl.focus();
        setTimeout(speakWord, 300);
    }

    inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') checkAnswer(); });

    function checkAnswer() {
        if (!currentWordObj) return;
        const userVal = inputEl.value.trim().toLowerCase();
        const correctVal = currentWordObj.en.trim().toLowerCase();
        
        if (userVal === correctVal) {
            score += 10;
        } else {
            score = Math.max(0, score - 5);
            historyOfWrongs.set(currentWordObj.zh, currentWordObj.en);
            inputEl.classList.add('error');
            setTimeout(() => inputEl.classList.remove('error'), 300);
        }
        document.getElementById('score').innerText = `å¾—åˆ†: ${score}`;
        nextQuestion();
    }

    function speakWord() {
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(currentWordObj.en);
        utter.lang = 'en-US';
        utter.rate = 0.85;
        window.speechSynthesis.speak(utter);
    }

    function endGame() {
        clearInterval(timerInterval);
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');

        // æ”¹ç‚ºæ¯ç§’ 1 åˆ†
        const timeBonus = Math.max(0, timeLeft); 
        const finalScore = score + timeBonus;
        
        document.getElementById('base-score').innerText = score;
        document.getElementById('time-bonus').innerText = `+ ${timeBonus}`;
        document.getElementById('final-score-val').innerText = finalScore;
        score = finalScore;

        if (historyOfWrongs.size > 0) {
            document.getElementById('wrong-words-section').classList.remove('hidden');
            let wrongHtml = "";
            historyOfWrongs.forEach((en, zh) => {
                wrongHtml += `<tr><td>${zh}</td><td style="color:var(--success); font-weight:bold;">${en}</td></tr>`;
            });
            document.getElementById('wrong-list-body').innerHTML = wrongHtml;
        }
        updateFinalRank();
    }

    async function saveScore() {
        const name = document.getElementById('player-name').value.trim();
        if(!name) { alert("è«‹è¼¸å…¥åå­—ï¼"); return; }
        document.getElementById('save-area').innerHTML = "<p>â³ å„²å­˜ä¸­...</p>";
        await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ name: name, score: score }) });
        setTimeout(() => {
            document.getElementById('save-area').innerHTML = "<p style='color:var(--success);'>âœ… ä¸Šå‚³æˆåŠŸï¼</p>";
            updateFinalRank();
        }, 1200);
    }

    async function updateFinalRank() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            renderTable('end-leaderboard-body', data);
        } catch (e) {}
    }
</script>
</body>
</html>
