<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªä¸‰æ¨¡å¼·åŒ–æŒ‘æˆ°è³½ - æœ€çµ‚æ•´åˆç‰ˆ</title>
    <style>
        :root { --primary: #6c5ce7; --success: #00b894; --danger: #ff7675; --dark: #2d3436; --light: #f9f9f9; --accent: #fdcb6e; }
        body { font-family: 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #app { background: white; width: 95%; max-width: 650px; padding: 25px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center; margin: 20px 0; }
        
        /* æ¨¡å¼é¸æ“‡éˆ• */
        .mode-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 20px 0; }
        .btn-mode { padding: 15px 10px; border-radius: 16px; border: 2px solid #eee; cursor: pointer; transition: 0.3s; background: white; }
        .btn-mode:hover { border-color: var(--primary); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-mode h3 { margin: 0 0 5px 0; color: var(--primary); font-size: 1.1rem; }
        .btn-mode p { margin: 0; font-size: 0.75rem; color: #666; line-height: 1.3; }

        /* éŠæˆ²ä»‹é¢ */
        .header-info { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; }
        .quiz-container { background: var(--light); padding: 25px; border-radius: 16px; margin-bottom: 20px; border: 2px solid #eee; min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #display-word { font-size: 2.8rem; margin: 0; color: var(--dark); word-break: break-all; }
        .listen-hint { font-size: 5rem; cursor: pointer; transition: 0.2s; user-select: none; }
        .listen-hint:active { transform: scale(0.9); }
        
        /* é¸é …æŒ‰éˆ• */
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .option-btn { padding: 12px; background: white; border: 2px solid #dfe6e9; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .option-btn:hover { border-color: var(--primary); background: #f8f8ff; }
        .option-btn.wrong { background: var(--danger); color: white; border-color: var(--danger); }

        /* æ’è¡Œæ¦œ */
        .rank-tabs { display: flex; gap: 4px; margin-top: 20px; }
        .rank-tab { flex: 1; padding: 10px 5px; font-size: 0.75rem; background: #eee; cursor: pointer; border-radius: 8px 8px 0 0; font-weight: bold; }
        .rank-tab.active { background: var(--primary); color: white; }
        .scroll-area { max-height: 200px; overflow-y: auto; background: #fafafa; border: 1px solid #eee; border-radius: 0 0 10px 10px; padding: 10px; }
        .rank-table, .wrong-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .rank-table td, .wrong-table td { padding: 8px; border-bottom: 1px solid #eee; }
        
        .wrong-box { background: #fff5f5; border: 2px solid #ff7675; border-radius: 16px; padding: 15px; margin-bottom: 20px; }
        .txt-wrong { color: var(--danger); text-decoration: line-through; font-size: 0.8rem; display: block; }
        .txt-correct { color: var(--success); font-weight: bold; }

        .hidden { display: none; }
        .btn { cursor: pointer; border: none; padding: 12px 28px; border-radius: 12px; font-weight: bold; transition: 0.3s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake { animation: shake 0.3s; }
    </style>
</head>
<body>

<div id="app">
    <div id="start-screen">
        <h1 style="color: var(--primary); margin-bottom: 5px;">ğŸ“ è‹±èªèƒ½åŠ›ä¸‰æ¨¡æŒ‘æˆ°</h1>
        <div id="status-msg" style="font-size: 0.8rem;">ğŸ“¡ è¼‰å…¥é›²ç«¯é¡Œåº«ä¸­...</div>
        
        <div id="mode-select" class="hidden">
            <div class="mode-container">
                <div class="btn-mode" onclick="setupGame(1)">
                    <h3>æ¨¡å¼ A</h3><p>æ‹¼å­—æŒ‘æˆ°<br>(çœ‹ä¸­æ‹¼è‹±)</p>
                </div>
                <div class="btn-mode" onclick="setupGame(2)">
                    <h3>æ¨¡å¼ B</h3><p>è¾¨èªæŒ‘æˆ°<br>(çœ‹è‹±é¸ä¸­)</p>
                </div>
                <div class="btn-mode" onclick="setupGame(3)">
                    <h3>æ¨¡å¼ C</h3><p>è½åŠ›æŒ‘æˆ°<br>(è½éŸ³é¸ç¾©)</p>
                </div>
            </div>

            <div class="rank-tabs">
                <div id="tabA" class="rank-tab active" onclick="switchTab('A')">æ‹¼å­—æ¦œ</div>
                <div id="tabB" class="rank-tab" onclick="switchTab('B')">è¾¨èªæ¦œ</div>
                <div id="tabC" class="rank-tab" onclick="switchTab('C')">è½åŠ›æ¦œ</div>
            </div>
            <div class="scroll-area"><table id="rank-body" class="rank-table"></table></div>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div class="header-info">
            <span id="timer-display" style="color: var(--danger);">â± 500s</span>
            <span id="score-info">ç©åˆ†: 0</span>
        </div>
        <div class="quiz-container">
            <h2 id="display-word">---</h2>
            <div id="word-type" style="color:var(--primary); font-weight:bold; margin-top:5px;"></div>
            <div id="listen-icon" class="listen-hint hidden" onclick="speakWord()">ğŸ”Š</div>
            <button id="repeat-btn" class="btn" style="background:var(--accent); margin-top:15px;" onclick="speakWord()">ğŸ”Š é‡è½ç™¼éŸ³</button>
        </div>

        <div id="mode-a-input" class="hidden">
            <div style="display:flex; gap:10px;">
                <input type="text" id="word-input" placeholder="è«‹æ‹¼å¯«è‹±æ–‡..." style="flex:1; padding:15px; font-size:1.5rem; border:2px solid #ddd; border-radius:12px; text-align:center;" autocapitalize="off" spellcheck="false" autocomplete="off">
                <button class="btn" style="background:var(--success); color:white;" onclick="checkAnswerModeA()">OK</button>
            </div>
        </div>

        <div id="mode-bc-options" class="hidden">
            <div class="options-grid" id="options-container"></div>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <h2>æŒ‘æˆ°çµæŸ</h2>
        <div id="wrong-summary-area" class="wrong-box hidden">
            <h3 style="margin:0 0 10px; color:var(--danger); font-size:0.9rem;">ğŸ” éŒ¯é¡Œå›é¡§</h3>
            <div class="scroll-area" style="background:white;"><table class="wrong-table"><tbody id="wrong-summary-body"></tbody></table></div>
        </div>
        <div id="result-stats" style="background: var(--light); padding:15px; border-radius:12px; text-align:left; margin-bottom:20px; border:1px solid #ddd;"></div>
        <div id="save-area">
            <input type="text" id="player-name" placeholder="è¼¸å…¥åå­—ç™»éŒ„æˆç¸¾" style="padding:10px; border-radius:8px; border:1px solid #ddd; width: 60%; margin-bottom:10px;">
            <button class="btn" style="background:var(--primary); color:white; width:100%;" onclick="saveScore()">ä¸Šå‚³æˆç¸¾</button>
        </div>
        <button class="btn" style="background:var(--success); color:white; width:100%; margin-top:15px;" onclick="location.reload()">å›é¦–é </button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbz9EaCviDbRaeWOSbOxPTZV69VAwqc8pr5YcboACUDoFWK1Dn1NCza5vnwRDBn21Sk/exec";
    
    let wordBank = [], activeQueue = [], currentWordObj;
    let gameMode = 1, timer = 500, score = 0, correctCount = 0, totalAnswered = 0, timerInterval;
    let wrongList = [], rankCache = { rankA: [], rankB: [], rankC: [] };

    window.onload = async () => {
        try {
            const [wordRes, rankRes] = await Promise.all([fetch(`${API_URL}?action=getWords`), fetch(API_URL)]);
            wordBank = await wordRes.json();
            const ranks = await rankRes.json();
            rankCache = { rankA: ranks.rankA || [], rankB: ranks.rankB || [], rankC: ranks.rankC || [] };
            document.getElementById('status-msg').classList.add('hidden');
            document.getElementById('mode-select').classList.remove('hidden');
            switchTab('A');
        } catch (e) { document.getElementById('status-msg').innerText = "âŒ ç„¡æ³•é€£ç·šè‡³è³‡æ–™åº«"; }
    };

    function switchTab(type) {
        ['A','B','C'].forEach(t => document.getElementById('tab'+t).classList.toggle('active', type === t));
        const data = rankCache['rank'+type];
        document.getElementById('rank-body').innerHTML = data.length ? data.map((r,i)=>`<tr><td>${i+1}. ${r[0]}</td><td align="right"><b>${r[1]}</b> åˆ†</td></tr>`).join('') : '<tr><td>æš«ç„¡æ’å</td></tr>';
    }

    function setupGame(mode) {
        gameMode = mode;
        score = 0; correctCount = 0; totalAnswered = 0; timer = 500; wrongList = [];
        activeQueue = [...wordBank].sort(() => Math.random() - 0.5);
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        document.getElementById('mode-a-input').classList.toggle('hidden', mode !== 1);
        document.getElementById('mode-bc-options').classList.toggle('hidden', mode === 1);
        document.getElementById('repeat-btn').classList.toggle('hidden', mode !== 1);
        document.getElementById('listen-icon').classList.toggle('hidden', mode !== 3);
        
        nextQuestion();
        startTimer();
    }

    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (timer > 0) { timer--; document.getElementById('timer-display').innerText = `â± ${timer}s`; }
            else { endGame(); }
        }, 1000);
    }

    function nextQuestion() {
        if (activeQueue.length === 0) { endGame(); return; }
        currentWordObj = activeQueue.shift();
        const displayWordEl = document.getElementById('display-word');
        const wordTypeEl = document.getElementById('word-type');

        if (gameMode === 1) { // æ¨¡å¼ Aï¼šçœ‹ä¸­æ‹¼è‹±
            displayWordEl.innerText = currentWordObj.zh;
            wordTypeEl.innerText = currentWordObj.type ? `[${currentWordObj.type}]` : "";
            document.getElementById('word-input').value = ""; document.getElementById('word-input').focus();
        } else if (gameMode === 2) { // æ¨¡å¼ Bï¼šçœ‹è‹±é¸ä¸­
            displayWordEl.innerText = currentWordObj.en;
            wordTypeEl.innerText = "";
            generateOptions();
        } else if (gameMode === 3) { // æ¨¡å¼ Cï¼šè½éŸ³é¸ç¾©
            displayWordEl.innerText = "";
            wordTypeEl.innerText = "è«‹è½éŸ³é¸å‡ºæ­£ç¢ºä¸­æ–‡";
            generateOptions();
        }
        speakWord();
    }

    function checkAnswerModeA() {
        const input = document.getElementById('word-input');
        const val = input.value.trim();
        if (!val) return;
        totalAnswered++;
        if (val.toLowerCase() === currentWordObj.en.toLowerCase()) { score += 10; correctCount++; nextQuestion(); }
        else { handleWrong(val); input.classList.add('shake'); setTimeout(()=> {input.classList.remove('shake'); nextQuestion();}, 300); }
        updateScoreUI();
    }

    function generateOptions() {
        const container = document.getElementById('options-container');
        container.innerHTML = "";
        let dists = wordBank.filter(w => w.zh !== currentWordObj.zh).sort(()=>Math.random()-0.5).slice(0, 9).map(w=>w.zh);
        [...dists, currentWordObj.zh].sort(()=>Math.random()-0.5).forEach(c => {
            const btn = document.createElement('button');
            btn.className = "option-btn"; btn.innerText = c;
            btn.onclick = () => {
                totalAnswered++;
                if (c === currentWordObj.zh) { score += 10; correctCount++; nextQuestion(); }
                else { handleWrong(c); btn.classList.add('wrong'); setTimeout(()=>nextQuestion(), 300); }
                updateScoreUI();
            };
            container.appendChild(btn);
        });
    }

    function handleWrong(userVal) {
        score = Math.max(0, score - 5);
        wrongList.push({ zh: currentWordObj.zh, en: currentWordObj.en, user: userVal });
    }

    function updateScoreUI() { document.getElementById('score-info').innerText = "ç©åˆ†: " + score; }

    function speakWord() { 
        window.speechSynthesis.cancel(); 
        const u = new SpeechSynthesisUtterance(currentWordObj.en); u.lang = 'en-US'; u.rate = 0.8;
        window.speechSynthesis.speak(u); 
    }

    function endGame() {
        clearInterval(timerInterval);
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        if (wrongList.length > 0) {
            document.getElementById('wrong-summary-area').classList.remove('hidden');
            document.getElementById('wrong-summary-body').innerHTML = wrongList.map(item => `<tr><td>${item.zh}</td><td><span class="txt-wrong">${item.user}</span></td><td><span class="txt-correct">${item.en}</span></td></tr>`).join('');
        }
        const finalScore = score + timer;
        const modes = ["","æ‹¼å­—","è¾¨èª","è½åŠ›"];
        document.getElementById('result-stats').innerHTML = `æ¨¡å¼ï¼š${modes[gameMode]}æŒ‘æˆ°<br>ç­”é¡Œç©åˆ†ï¼š${score}<br>æ™‚é–“ç´…åˆ©ï¼š+${timer}<br><b>ç¸½ç©åˆ†ï¼š${finalScore}</b>`;
        score = finalScore;
    }

    async function saveScore() {
        const name = document.getElementById('player-name').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥åå­—");
        document.getElementById('save-area').innerHTML = "â³ åŒæ­¥ä¸­...";
        const acc = Math.round((correctCount / (totalAnswered || 1)) * 100) + "%";
        const modeNames = ["","æ‹¼å­—","è¾¨èª","è½åŠ›"];
        try {
            await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ name: name, score: score, accuracy: acc, mode: modeNames[gameMode] }) });
            document.getElementById('save-area').innerHTML = "<p style='color:var(--success); font-weight:bold;'>âœ… ä¸Šå‚³æˆåŠŸï¼</p>";
        } catch(e) {
            document.getElementById('save-area').innerHTML = "<p style='color:var(--danger);'>âŒ ä¸Šå‚³å¤±æ•—</p>";
        }
    }

    document.getElementById('word-input').addEventListener('keydown', (e) => { if(e.key === 'Enter') checkAnswerModeA(); });
</script>
</body>
</html>
