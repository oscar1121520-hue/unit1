<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å¼è‹±èªæŒ‘æˆ° - è©æ€§èˆ‡æ­£ç¢ºç‡å¼·åŒ–ç‰ˆ</title>
    <style>
        :root { --primary: #6c5ce7; --success: #00b894; --danger: #ff7675; --dark: #2d3436; --light: #f9f9f9; --accent: #fdcb6e; }
        body { font-family: 'Segoe UI', 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #app { background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); text-align: center; margin: 20px 0; }
        .header-info { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; font-size: 0.9rem; }
        .quiz-container { background: var(--light); padding: 25px; border-radius: 16px; margin-bottom: 20px; border: 2px solid #eee; }
        #chinese-word { font-size: 2.8rem; margin: 0; color: var(--dark); }
        #word-type { color: var(--primary); font-weight: bold; font-size: 1.1rem; margin-top: 5px; height: 1.5rem; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        #word-input { flex: 1; padding: 15px; font-size: 1.5rem; border: 3px solid #dfe6e9; border-radius: 12px; text-align: center; outline: none; width: 100%; }
        #word-input.error { border-color: var(--danger); animation: shake 0.3s; }
        .btn-ok { background: var(--success); color: white; padding: 0 25px; font-size: 1.2rem; border-radius: 12px; cursor: pointer; border: none; font-weight: bold; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .btn { cursor: pointer; border: none; padding: 12px 28px; border-radius: 12px; font-size: 1.1rem; font-weight: bold; transition: 0.3s; margin: 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-audio { background: var(--accent); color: #634d00; margin-top: 15px; }
        .scroll-area { max-height: 180px; overflow-y: auto; background: #fafafa; border-radius: 10px; padding: 10px; border: 1px solid #eee; margin-top: 10px; }
        .leaderboard-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .leaderboard-table th, .leaderboard-table td { padding: 8px; border-bottom: 1px solid #eee; text-align: center; }
        .hidden { display: none; }
        .score-detail { background: var(--light); padding: 15px; border-radius: 12px; margin-bottom: 15px; font-size: 0.9rem; text-align: left; }
    </style>
</head>
<body>

<div id="app">
    <div id="start-screen">
        <h1 style="color: var(--primary);">ğŸ§ æ‹¼å­—æŒ‘æˆ° (500ç§’)</h1>
        <div id="status-msg" style="font-size: 0.9rem; margin-bottom: 10px;">ğŸ“¡ æ­£åœ¨é€£ç·šé›²ç«¯...</div>
        <button id="start-btn" class="btn btn-primary hidden" onclick="initGame()">é–‹å§‹æŒ‘æˆ°</button>
        <div id="pre-leaderboard" class="hidden">
            <h3 style="color:var(--primary); margin-top:20px;">ğŸ† é«˜æ‰‹æ¦œ Top 10</h3>
            <div class="scroll-area">
                <table class="leaderboard-table">
                    <thead><tr><th>åæ¬¡</th><th>ç©å®¶</th><th>åˆ†æ•¸</th><th>æ­£ç¢ºç‡</th></tr></thead>
                    <tbody id="start-leaderboard-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div class="header-info">
            <span id="timer" style="color:var(--danger)">â± 08:20</span>
            <span id="accuracy-display" style="color:var(--primary)">æ­£ç¢ºç‡: 0%</span>
            <span id="score" style="color:var(--success)">å¾—åˆ†: 0</span>
        </div>
        <div class="quiz-container">
            <h2 id="chinese-word">---</h2>
            <div id="word-type"></div>
            <button class="btn btn-audio" onclick="speakWord()">ğŸ”Š è½ç™¼éŸ³</button>
        </div>
        <div class="input-group">
            <input type="text" id="word-input" placeholder="è«‹æ‹¼å­—..." autocomplete="off">
            <button class="btn-ok" onclick="checkAnswer()">OK</button>
        </div>
    </div>

    <div id="result-screen" class="hidden">
        <h2 style="margin-bottom:10px">æŒ‘æˆ°çµæŸ</h2>
        <div class="score-detail">
            <div style="margin-bottom:5px;">ç­”é¡Œç´¯ç©å¾—åˆ†ï¼š<span id="base-score" style="float:right">0</span></div>
            <div style="margin-bottom:5px;">ç­”é¡Œæ­£ç¢ºç‡ï¼š<span id="final-accuracy" style="float:right">0%</span></div>
            <div style="color:var(--primary); margin-bottom:5px;">å‰©é¤˜æ™‚é–“çå‹µ (1ç§’/1åˆ†)ï¼š<span id="time-bonus" style="float:right">0</span></div>
            <hr style="border:0; border-top:1px solid #ddd; margin:10px 0;">
            <div style="font-weight:bold; font-size:1.4rem;">æœ€çµ‚ç¸½ç©åˆ†ï¼š<span id="final-score-val" style="float:right; color:var(--success)">0</span></div>
        </div>
        <div id="save-area">
            <input type="text" id="player-name" placeholder="è¼¸å…¥åå­—" style="padding:10px; border-radius:8px; border:1px solid #ddd; width: 45%;">
            <button class="btn btn-primary" onclick="saveScore()">ä¸Šå‚³æˆç¸¾</button>
        </div>
        <h3 style="margin-top:20px;">ğŸ† å…¨çƒæ’è¡Œæ¦œ</h3>
        <div class="scroll-area">
            <table class="leaderboard-table">
                <thead><tr><th>åæ¬¡</th><th>ç©å®¶</th><th>åˆ†æ•¸</th><th>æ­£ç¢ºç‡</th></tr></thead>
                <tbody id="end-leaderboard-body"></tbody>
            </table>
        </div>
        <button class="btn btn-primary" style="background:var(--success); width:100%; margin-top:20px;" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<script>
    // å·²æ›´æ–°ç‚ºæ‚¨çš„ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbz9EaCviDbRaeWOSbOxPTZV69VAwqc8pr5YcboACUDoFWK1Dn1NCza5vnwRDBn21Sk/exec";

    let wordBank = [], activeQueue = [], currentWordObj;
    let score = 0, timeLeft = 500, timerInterval;
    let correctCount = 0, totalAnswered = 0, finalAcc = 0;

    window.onload = async () => {
        const msg = document.getElementById('status-msg');
        try {
            const [wordRes, rankRes] = await Promise.all([
                fetch(`${API_URL}?action=getWords`),
                fetch(API_URL)
            ]);
            wordBank = await wordRes.json();
            const rankData = await rankRes.json();
            
            if (wordBank && wordBank.length > 0) {
                msg.innerText = "âœ… è³‡æ–™åŒæ­¥æˆåŠŸï¼";
                document.getElementById('start-btn').classList.remove('hidden');
                if (rankData) renderRankTable('start-leaderboard-body', rankData);
                document.getElementById('pre-leaderboard').classList.remove('hidden');
            }
        } catch (e) {
            msg.innerText = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Apps Script éƒ¨ç½²è¨­å®šã€‚";
        }
    };

    function renderRankTable(id, data) {
        document.getElementById(id).innerHTML = data.map((r, i) => `
            <tr>
                <td>${i+1}</td>
                <td style="font-weight:bold; text-align:left;">${r[0]}</td>
                <td style="color:var(--primary); font-weight:bold;">${r[1]}</td>
                <td>${r[3] || '--'}</td>
            </tr>
        `).join('');
    }

    function initGame() {
        score = 0; timeLeft = 500; correctCount = 0; totalAnswered = 0; finalAcc = 0;
        activeQueue = [...wordBank].sort(() => Math.random() - 0.5);
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('accuracy-display').innerText = `æ­£ç¢ºç‡: 0%`;
        document.getElementById('score').innerText = `å¾—åˆ†: 0`;
        nextQuestion();
        startTimer();
    }

    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            let m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            let s = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `â± ${m}:${s}`;
            if (timeLeft <= 0) endGame();
        }, 1000);
    }

    function nextQuestion() {
        if (activeQueue.length === 0) { endGame(); return; }
        currentWordObj = activeQueue.shift();
        document.getElementById('chinese-word').innerText = currentWordObj.zh;
        document.getElementById('word-type').innerText = currentWordObj.type ? `[${currentWordObj.type}]` : "";
        document.getElementById('word-input').value = "";
        document.getElementById('word-input').focus();
        speakWord();
    }

    function checkAnswer() {
        const input = document.getElementById('word-input');
        const userVal = input.value.trim().toLowerCase();
        if (!userVal) return;

        totalAnswered++;
        if (userVal === currentWordObj.en.toLowerCase()) {
            score += 10;
            correctCount++;
        } else {
            score = Math.max(0, score - 5);
            input.classList.add('error');
            setTimeout(() => input.classList.remove('error'), 300);
        }
        
        finalAcc = Math.round((correctCount / totalAnswered) * 100);
        document.getElementById('accuracy-display').innerText = `æ­£ç¢ºç‡: ${finalAcc}%`;
        document.getElementById('score').innerText = `å¾—åˆ†: ${score}`;
        nextQuestion();
    }

    function speakWord() {
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(currentWordObj.en);
        utter.lang = 'en-US';
        utter.rate = 0.85;
        window.speechSynthesis.speak(utter);
    }

    function endGame() {
        clearInterval(timerInterval);
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');

        const timeBonus = Math.max(0, timeLeft);
        document.getElementById('base-score').innerText = score;
        document.getElementById('final-accuracy').innerText = `${finalAcc}% (${correctCount}/${totalAnswered})`;
        document.getElementById('time-bonus').innerText = `+ ${timeBonus}`;
        
        score += timeBonus;
        document.getElementById('final-score-val').innerText = score;
        updateRank();
    }

    async function saveScore() {
        const name = document.getElementById('player-name').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥åå­—");
        document.getElementById('save-area').innerHTML = "â³ å„²å­˜ä¸­...";
        
        await fetch(API_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({ name: name, score: score, accuracy: finalAcc })
        });
        
        setTimeout(() => {
            document.getElementById('save-area').innerHTML = "<p style='color:var(--success); font-weight:bold;'>âœ… æˆç¸¾å·²ç™»éŒ„</p>";
            updateRank();
        }, 1200);
    }

    async function updateRank() {
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            renderRankTable('end-leaderboard-body', data);
        } catch (e) {}
    }

    document.getElementById('word-input').addEventListener('keydown', (e) => {
        if(e.key === 'Enter') checkAnswer();
    });
</script>
</body>
</html>
